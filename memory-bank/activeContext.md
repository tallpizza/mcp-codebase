# 활성 컨텍스트

## 현재 작업 포커스

- MCP 서버 프로젝트 핵심 기능 구현
- 기본 API 엔드포인트 구현 완료
- 임베딩 서비스 연결 계획
- 벡터 검색 기능 구현 준비
- 코드 청킹 문제 해결 완료
- 성능 최적화 준비

## 최근 활동 요약

- PostgreSQL 데이터베이스 설정 및 pgvector 확장 활성화 완료
- 데이터베이스 마이그레이션 설정 및 실행 완료
- 코드 청킹 서비스 구현 (src/services/codeChunkingService.ts)
  - 프로젝트 전체 코드 청킹 기능
  - 단일 파일 코드 청킹 기능
  - 재귀적 파일 탐색 기능
  - 심볼 기반 코드 청크 추출
  - 에러 처리 개선으로 개별 파일 오류가 전체 프로세스를 중단시키지 않도록 함
- 코드 청크 저장소 구현 (src/services/codeChunkRepository.ts)
  - 프로젝트 및 코드 청크 CRUD 기능
  - 프로젝트별 코드 청크 조회 기능
  - 기본 검색 기능 설계
- 프로젝트 관리 API 구현 (src/routes/projects.ts)
  - 프로젝트 생성, 조회, 목록 엔드포인트
  - 코드 청킹 시작 엔드포인트 (에러 처리 개선)
  - 코드 청크 조회 엔드포인트
- 파일 시스템 API 구현 (src/routes/files.ts)
  - 디렉토리 목록 조회 기능 구현
  - 파일 내용 조회 기능 구현
- 사용자 경험 개선 기능 추가
  - 프로젝트 생성 시 폴더 경로에서 자동으로 이름 추출 기능 구현
- 코드 청킹 API 오류 해결
  - 오류 처리 및 로깅 개선
  - 개별 파일 오류가 전체 프로세스를 중단시키지 않도록 개선

## 진행 중인 결정사항

1. **폴더 구조 설계**

   - src/services: 비즈니스 로직 서비스
   - src/routes: API 라우터
   - src/models: 데이터 모델
   - src/db: 데이터베이스 관련
   - src/utils: 유틸리티 함수

2. **API 엔드포인트 설계**

   - '/projects': 프로젝트 관리 API
   - '/files': 파일 시스템 API
   - '/code': 코드 분석 및 검색 API (구현 예정)
   - RESTful 방식으로 구현

3. **임베딩 서비스 설계**

   - OpenAI API 사용
   - 텍스트 전처리 파이프라인
   - 임베딩 벡터 정규화
   - 임베딩 저장 및 벡터 검색 전략

4. **코드 청킹 전략**

   - LSP를 통한 심볼 추출 완료
   - 함수, 클래스, 인터페이스/타입 분류 완료
   - 심볼 정보에서 코드 청크 변환 구현
   - 코드 청킹 API 오류 해결 완료
   - 의존성 분석 방법 결정 필요

5. **프로젝트 관리 전략**

   - 프로젝트 메타데이터 관리 구현
   - 프로젝트별 코드 청크 조직화 구현
   - 프로젝트 단위 API 완료
   - 사용성 향상: 경로에서 프로젝트 이름 자동 추출

## 다음 단계

1. **임베딩 서비스 구현**

   - OpenAI API 연결
   - src/services/embeddingService.ts 구현
   - 코드 전처리 및 임베딩 생성 로직 구현
   - 벡터 저장 및 검색 기능 구현

2. **코드 검색 API 구현**

   - src/routes/code.ts 구현
   - 임베딩 기반 검색 엔드포인트 구현
   - 프로젝트별 필터링 지원
   - 코드 의존성 조회 기능 구현

3. **성능 최적화**

   - 대규모 프로젝트 처리 최적화
   - LSP 클라이언트 리소스 사용 최적화
   - 청킹 및 검색 쿼리 최적화

4. **통합 및 테스트**

   - 엔드-투-엔드 테스트 구현
   - 에러 처리 개선
   - 전체 파이프라인 테스트

## 구현 전략 및 결정 사항

1. **LSP 클라이언트**

   - 표준 입출력 기반 통신 사용
   - 심볼 정보 추출에 초점
   - 파일당 한 번 요청 전략 채택
   - 커스텀 tsserver 경로 지정 대신 기본 설치된 typescript-language-server 활용

2. **코드 청킹**

   - 프로젝트 단위 청킹 구현
   - 파일 단위 청킹 구현
   - TypeScript/JavaScript 파일 지원
   - node_modules 등 제외 경로 설정
   - 개별 파일 오류 처리 개선으로 안정성 향상

3. **데이터베이스**

   - PostgreSQL + pgvector 사용
   - 프로젝트 테이블 및 코드 청크 테이블 정의
   - 임베딩 필드를 통한 벡터 검색 지원
   - Drizzle ORM 사용하여 타입 안전성 보장

4. **API 설계**

   - RESTful API 구현
   - 명확한 엔드포인트 구조
   - JSON 응답 형식 표준화
   - 적절한 HTTP 상태 코드 사용
   - 사용자 친화적 기능: 경로 기반 이름 자동화

5. **에러 처리**

   - 일관된 에러 응답 형식
   - 세부적인 에러 메시지 및 디버깅 정보 제공
   - 에러 로깅 전략 개선
   - try-catch 블록을 통한 세분화된 에러 처리

## 최근 변경 사항

1. **디렉토리 코드 청킹 기능 추가**:

   - `CodeChunkingService`에 `chunkDirectory` 메서드 추가
   - 특정 디렉토리의 모든 TS/JS 파일에서 코드 청크를 추출하는 기능 구현
   - 기존 `chunkEntireProject` 메서드는 내부적으로 `chunkDirectory`를 활용하도록 리팩토링

2. **LSP 클라이언트 개선**:

   - 서버 시작 시 로컬 node_modules 폴더의 typescript-language-server 사용
   - 초기화, 연결 및 심볼 조회 과정에 상세한 로깅 추가
   - 재시도 로직을 추가하여 LSP 클라이언트 안정성 향상
   - 서버 응답 관련 오류 상황에 대한 처리 개선

3. **코드 청킹 에러 처리 개선**:

   - 파일 접근 및 읽기 오류 처리 로직 추가
   - 심볼 처리 및 코드 추출 과정의 오류 처리 개선
   - 빈 파일 및 심볼이 없는 파일에 대한 예외 처리
   - 개별 파일 처리 실패 시에도 전체 프로세스 진행 보장

4. **API 엔드포인트 추가**:

   - 디렉토리 코드 청킹을 위한 `/projects/:id/chunk/directory` 엔드포인트 추가
   - 요청 본문에서 디렉토리 경로를 받아 처리

5. **코드 청크 저장소 개선**:
   - 청크 저장 및 조회 과정의 오류 처리 강화
   - 코드 청크 충돌 처리를 위한 `onConflictDoUpdate` 로직 추가
   - 데이터베이스와 서비스 객체 간 타입 변환 로직 추가
   - 청크 수 조회 기능 구현

## 활성 결정 사항

1. **청킹 프로세스 안정성 우선**:

   - 개별 파일 오류가 전체 청킹 프로세스를 중단시키지 않도록 함
   - 실패한 파일에 대한 상세 로깅을 통해 진단 용이성 확보

2. **심볼 처리 전략**:

   - LSP 클라이언트를 통해 코드 심볼 추출
   - 파일 내용에 대한 기본 구문 분석으로 심볼 존재 여부 사전 확인
   - DocumentSymbol을 SymbolInformation으로 변환하는 과정 개선

3. **에러 처리 및 로깅 전략**:

   - 오류 발생 지점마다 상세한 로그 기록
   - 예외 발생 시 해당 작업만 실패하고 전체 프로세스는 계속 진행
   - 오류 메시지에 관련 파일 경로 및 컨텍스트 포함

4. **데이터베이스 접근 전략**:
   - 서비스 객체와 DB 스키마 객체 간 명확한 구분
   - 타입 안전성을 위한 매핑 함수 구현
   - 벌크 삽입 대신 충돌 처리 로직 사용으로 데이터 일관성 유지

## 다음 단계

1. 임베딩 서비스 구현 및 코드 청크 벡터화
2. 코드 청크 검색 API 개발
3. 프로젝트 및 디렉토리 구조 시각화 기능
4. 코드 청크 간 의존성 분석 기능
5. 전체 시스템 통합 테스트
6. 성능 최적화 및 대규모 코드베이스 처리 개선

# 현재 작업 컨텍스트

## 최근 변경사항

1. **LSP에서 AST로 전환**

   - TypeScript 컴파일러 API 직접 사용으로 변경
   - LSP 의존성 제거
   - 코드 분석 정확도 향상

2. **코드 분석 개선**

   - AST 기반 코드 구조 분석
   - 타입 체커를 통한 정확한 심볼 분석
   - 의존성 그래프 구축 개선
   - 파일 경로 처리 최적화

3. **성능 최적화**
   - TypeScript 프로그램 재사용
   - 타입 체커 캐싱
   - 병렬 처리 지원
   - 메모리 사용량 최적화

## 현재 상태

1. **완료된 작업**

   - LSP 의존성 제거
   - TypeScript AST 기반 분석 구현
   - 코드 청크 추출 로직 개선
   - 의존성 분석 정확도 향상

2. **진행 중인 작업**

   - 성능 최적화
   - 에러 처리 강화
   - 메모리 사용량 모니터링
   - 배치 처리 개선

3. **다음 단계**
   - 에러 복구 메커니즘 구현
   - 성능 메트릭 수집
   - 리소스 사용량 모니터링
   - 대규모 코드베이스 처리 최적화

## 주요 이슈 및 해결 방안

1. **코드 분석 정확도**

   - 문제: LSP 기반 분석의 한계
   - 해결: TypeScript AST 직접 사용
   - 결과: 더 정확한 코드 구조 분석

2. **성능 최적화**

   - 문제: 대규모 코드베이스 처리 시 성능 저하
   - 해결: 프로그램 재사용 및 캐싱
   - 진행 중: 병렬 처리 최적화

3. **메모리 관리**
   - 문제: AST 분석 시 메모리 사용량 증가
   - 해결: 점진적 처리 및 메모리 해제
   - 모니터링: 메모리 사용량 추적

## 구현 우선순위

1. **안정성**

   - AST 분석 에러 처리
   - 메모리 관리 개선
   - 에러 복구 메커니즘

2. **성능**

   - 병렬 처리 최적화
   - 캐싱 전략 개선
   - 배치 크기 조정

3. **모니터링**
   - 성능 메트릭 수집
   - 메모리 사용량 추적
   - 에러 발생 패턴 분석
